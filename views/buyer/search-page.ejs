<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buyer Dashboard - PubliShelf</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="/css/styles.css">
</head>

<body class="bg-gray-50">
    <nav class="fixed w-full bg-white shadow-sm z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <a href="/buyer/dashboard" class="flex items-center">
                        <span
                            class="text-2xl font-bold bg-gradient-to-r from-purple-600 to-indigo-600 text-transparent bg-clip-text">PubliShelf</span>
                    </a>
                </div>
                <div class="flex items-center md:space-x-8 relative">
                    <a href="/buyer/cart/#wishlist-section" class="text-gray-700 hover:text-purple-600 hidden md:block">
                        <i class="far fa-heart"></i>
                    </a>
                    <a href="/buyer/cart" class="text-gray-700 hover:text-purple-600 hidden md:block">
                        <i class="fas fa-shopping-cart"></i>
                    </a>

                    <button onclick="window.location.href='/buyer/auction-page'"
                        class="bg-gradient-to-r hover:bg-gradient-to-l from-purple-600 to-indigo-600 text-white px-4 py-2 rounded-lg hover:-translate-y-[2px] transition-all duration-300  hidden md:block">Enter
                        Auction</button>

                    <div class="relative group">
                        <button class="scale-0 md:scale-100 flex items-center space-x-2"
                            onclick="window.location.href='/buyer/profile'">
                            <img src="https://img.icons8.com/?size=100&id=zxB19VPoVLjK&format=png&color=000000"
                                alt="Profile" class="w-5 h-5 rounded-full">
                            <span class="text-gray-700">
                                <%= buyerName %>
                            </span>
                        </button>
                        <div
                            class="absolute top-full right-1 w-48 bg-white shadow-lg rounded-lg py-2 hidden group-hover:block">
                            <a href="/buyer/profile" class="<%= styles.categoryBtnStyle %>">Your Profile</a>
                            <a href="/buyer/auction-page" class="<%= styles.categoryBtnStyle %>">Enter Auction</a>
                        </div>
                    </div>
                    <div class="relative group">
                        <button class="md:hidden flex items-center space-x-2">
                            <img src="https://img.icons8.com/?size=100&id=zxB19VPoVLjK&format=png&color=000000"
                                alt="Profile" class="w-5 h-5 rounded-full"></button>
                        <div
                            class="absolute top-full right-1 w-48 bg-white shadow-lg rounded-lg py-2 hidden group-hover:block">
                            <a href="/buyer/profile" class="<%= styles.categoryBtnStyle %>">Your Profile</a>
                            <a href="/buyer/cart/#wishlist-section" class="<%= styles.categoryBtnStyle %>">WishList</a>
                            <a href="/buyer/cart" class="<%= styles.categoryBtnStyle %>">Cart</a>
                            <a href="/logout" class="<%= styles.categoryBtnStyle %>">Logout</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="pt-16">
        <div class="bg-white border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex space-x-8 py-4">
                    <a href="#" class="text-purple-600 border-b-2 border-purple-600 pb-4 -mb-4">All Books</a>
                    <a href="#" class="text-gray-600 hover:text-purple-600">Fiction</a>
                    <a href="#" class="text-gray-600 hover:text-purple-600">Non-Fiction</a>
                    <a href="#" class="text-gray-600 hover:text-purple-600">Mystery</a>
                    <a href="#" class="text-gray-600 hover:text-purple-600">Science Fiction</a>
                    <a href="#" class="text-gray-600 hover:text-purple-600">Romance</a>
                    <a href="#" class="text-gray-600 hover:text-purple-600">Thriller</a>
                    <a href="#" class="text-gray-600 hover:text-purple-600">Other</a>
                </div>
            </div>
        </div>

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-4 mb-8 bg-white/80 backdrop-blur-sm border border-gray-200 rounded-2xl shadow-sm px-4 py-3 transition-all">
                
                <div>
                    <h2 class="text-lg md:text-xl font-semibold text-gray-800 tracking-tight">
                        Filter & Sort Books
                    </h2>
                    <p class="text-sm text-gray-500 hidden sm:block">Refine your results by price or sort preferences</p>
                </div>

                <div class="flex flex-wrap items-center gap-3">
                    <div class="relative">
                        <select id="sortSelect" 
                            class="appearance-none px-4 py-2.5 pr-10 rounded-lg border border-gray-300 bg-white text-gray-700 text-sm font-medium focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition">
                            <option value="relevance">Sort by: Relevance</option>
                            <option value="price-asc">Price: Low to High</option>
                            <option value="price-desc">Price: High to Low</option>
                            <option value="rating-desc">Rating: High to Low</option>
                            <option value="rating-asc">Rating: Low to High</option>
                            <option value="quantity-desc">Quantity: High to Low</option>
                            <option value="quantity-asc">Quantity: Low to High</option>
                            <option value="newest">Newest First</option>
                        </select>
                        <i class="fas fa-chevron-down absolute right-3 top-3 text-gray-500 pointer-events-none text-xs"></i>
                    </div>

                    <div class="relative">
                        <select id="priceRangeSelect" 
                            class="appearance-none px-4 py-2.5 pr-10 rounded-lg border border-gray-300 bg-white text-gray-700 text-sm font-medium focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition">
                            <option value="all">All Prices</option>
                            <option value="under500">Under ₹500</option>
                            <option value="500-1000">₹500 - ₹1000</option>
                            <option value="1000-2000">₹1000 - ₹2000</option>
                            <option value="2000-3000">₹2000 - ₹3000</option>
                            <option value="over3000">Over ₹3000</option>
                        </select>
                        <i class="fas fa-chevron-down absolute right-3 top-3 text-gray-500 pointer-events-none text-xs"></i>
                    </div>

                    <button id="resetFiltersBtn" 
                        class="flex items-center gap-2 px-4 py-2 text-sm font-medium text-purple-600 border border-purple-200 rounded-lg hover:bg-purple-50 hover:text-purple-700 transition">
                        <i class="fas fa-undo-alt text-sm"></i> Reset
                    </button>
                </div>
            </div>  

            <div id="bookGrid" class="grid grid-cols-2 md:grid-cols-4 gap-6">
                <% newlyBooks.forEach(book => { %>
                    <div onclick="window.location.href='/buyer/product-detail/<%= book._id %>'"
                    class="relative bg-white rounded-lg shadow-md overflow-hidden hover:-translate-y-1 transition-transform cursor-pointer <%= styles.bookCardStyle || '' %>">
                        <img src="<%= book.image %>" alt="<%= book.title %>" class="w-full h-40 md:h-64 object-cover">
                        <div class="p-3 md:p-4">
                            <h3 class="text-lg font-semibold mb-1 truncate"><%= book.title %></h3>
                            <p class="text-gray-600 text-sm mb-2">by <%= book.author %></p>
                            <div class="flex justify-between items-center">
                                <div class="flex items-center">
                                </div>
                                <span class="font-bold text-purple-600 text-sm">
                                    ₹<%= book.price %>
                                </span>
                            </div>
                            <button class="bottom-3 right-3 wishlist-btn text-gray-600 hover:text-red-500" data-book-id="<%= book._id %>">
                                <i class="far fa-heart text-xl"></i>
                            </button>
                        </div>
                    </div>
                <% }); %>
            </div>

            <!-- <div class="flex justify-center mt-8">
                <nav class="flex space-x-2">
                    <a href="#" class="px-3 py-2 rounded-lg bg-purple-600 text-white">1</a>
                    <a href="#" class="px-3 py-2 rounded-lg text-gray-600 hover:bg-purple-50">2</a>
                    <a href="#" class="px-3 py-2 rounded-lg text-gray-600 hover:bg-purple-50">3</a>
                    <span class="px-3 py-2">...</span>
                    <a href="#" class="px-3 py-2 rounded-lg text-gray-600 hover:bg-purple-50">10</a>
                </nav>
            </div> -->
        </div>
    </div>

    <script src="/js/script.js"></script>
    <script>
        const allBooks = JSON.parse(`<%- JSON.stringify(newlyBooks || []) %>`);

        const bookGrid = document.getElementById('bookGrid');
        const categoryLinks = document.querySelectorAll('.bg-white.border-b a');
        const sortSelect = document.getElementById('sortSelect');
        const priceRangeSelect = document.getElementById('priceRangeSelect');

        let currentCategory = 'All Books';
        let currentPriceFilter = 'all';
        let currentSort = 'relevance';
        let currentBooks = [...allBooks];

        function renderBooks(books) {
            bookGrid.innerHTML = '';
            if (books.length === 0) {
                bookGrid.innerHTML = `
                    <div class="col-span-full text-center text-gray-500 py-10">
                        No books found for selected filters.
                    </div>`;
                return;
            }
            books.forEach(book => {
                const card = document.createElement('div');
                card.className = "relative bg-white rounded-lg shadow-md overflow-hidden hover:-translate-y-1 transition-transform cursor-pointer";
                card.onclick = () => window.location.href = `/buyer/product-detail/${book._id}`;
                card.innerHTML = `
                    <img src="${book.image}" alt="${book.title}" class="w-full h-40 md:h-64 object-cover">
                    <div class="p-3 md:p-4">
                        <h3 class="text-lg font-semibold mb-1 truncate">${book.title}</h3>
                        <p class="text-gray-600 text-sm mb-2">by ${book.author}</p>
                        <div class="flex justify-between items-center">
                            <span class="font-bold text-purple-600 text-sm">
                                ₹${book.price}
                            </span>
                        </div>
                        <button class="absolute bottom-3 right-3 wishlist-btn text-gray-600 hover:text-red-500" data-book-id="${book._id}">
                            <i class="far fa-heart text-xl"></i>
                        </button>
                    </div>`;
                bookGrid.appendChild(card);
            });
        }

        function filterByPriceRange(books, priceRange) {
            switch (priceRange) {
                case 'under500':
                    return books.filter(book => (book.price || 0) < 500);
                case '500-1000':
                    return books.filter(book => (book.price || 0) >= 500 && (book.price || 0) <= 1000);
                case '1000-2000':
                    return books.filter(book => (book.price || 0) >= 1000 && (book.price || 0) <= 2000);
                case '2000-3000':
                    return books.filter(book => (book.price || 0) >= 2000 && (book.price || 0) <= 3000);
                case 'over3000':
                    return books.filter(book => (book.price || 0) > 3000);
                case 'all':
                default:
                    return books;
            }
        }

        function sortBooks(books, sortBy) {
            const sorted = [...books];
            switch (sortBy) {
                case 'price-asc':
                    return sorted.sort((a, b) => (a.price || 0) - (b.price || 0));
                case 'price-desc':
                    return sorted.sort((a, b) => (b.price || 0) - (a.price || 0));
                case 'rating-desc':
                    return sorted.sort((a, b) => (b.rating || 0) - (a.rating || 0));
                case 'rating-asc':
                    return sorted.sort((a, b) => (a.rating || 0) - (b.rating || 0));
                case 'quantity-desc':
                    return sorted.sort((a, b) => (b.quantity || 0) - (a.quantity || 0));
                case 'quantity-asc':
                    return sorted.sort((a, b) => (a.quantity || 0) - (b.quantity || 0));
                case 'newest':
                    return sorted.sort((a, b) => new Date(b.publishedAt) - new Date(a.publishedAt));
                case 'relevance':
                default:
                    return sorted; 
            }
        }
        function filterByCategory(books, category) {
            if (category === 'All Books') return books;
            return books.filter(book =>
                book.genre && book.genre.toLowerCase().includes(category.toLowerCase())
            );
        }

        function applyFiltersAndSort() {
            let filteredBooks = [...allBooks];

            filteredBooks = filterByCategory(filteredBooks, currentCategory);
            filteredBooks = filterByPriceRange(filteredBooks, currentPriceFilter);
            filteredBooks = sortBooks(filteredBooks, currentSort);

            currentBooks = filteredBooks;
            renderBooks(currentBooks);
        }

        renderBooks(currentBooks);
        categoryLinks.forEach(link => {
            link.addEventListener('click', e => {
                e.preventDefault();
                categoryLinks.forEach(l => l.classList.remove('text-purple-600', 'border-b-2', 'border-purple-600'));
                link.classList.add('text-purple-600', 'border-b-2', 'border-purple-600');

                currentCategory = link.textContent.trim();
                applyFiltersAndSort();
            });
        });

        priceRangeSelect.addEventListener('change', () => {
            currentPriceFilter = priceRangeSelect.value;
            applyFiltersAndSort();
        });

        sortSelect.addEventListener('change', () => {
            currentSort = sortSelect.value;
            applyFiltersAndSort();
        });

        document.addEventListener('click', async (e) => {
            const button = e.target.closest('.wishlist-btn');
            if (!button) return;
            const bookId = button.getAttribute('data-book-id');
            try {
                const response = await fetch('/buyer/wishlist/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ bookId }),
                });
                if (response.ok) {
                    button.querySelector('i').classList.replace('far', 'fas');
                    button.classList.add('text-red-500');
                } else {
                    const error = await response.json();
                    alert(`Failed to add to wishlist: ${error.message}`);
                }
            } catch (err) {
                console.error('Error adding to wishlist:', err);
            }
        });
        document.getElementById('resetFiltersBtn').addEventListener('click', () => {
            currentCategory = 'All Books';
            currentPriceFilter = 'all';
            currentSort = 'relevance';
            sortSelect.value = 'relevance';
            priceRangeSelect.value = 'all';
            categoryLinks.forEach(l => l.classList.remove('text-purple-600', 'border-b-2', 'border-purple-600'));
            categoryLinks[0]?.classList.add('text-purple-600', 'border-b-2', 'border-purple-600'); // Highlight 'All Books'
            applyFiltersAndSort();
        
        });

    </script>


</body>

</html>