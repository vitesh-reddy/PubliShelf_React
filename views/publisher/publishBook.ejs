<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Publish Book - PubliShelf</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="../../public/css/styles.css">
    <link rel="stylesheet" href="/css/styles.css">
</head>

<body class="bg-gray-50">
    <nav class="fixed w-full bg-white shadow-sm z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="h-16 flex justify-between">
                <div class="flex items-center">
                    <a href="/publisher/dashboard" class="flex items-center">
                        <i class="fas fa-arrow-left text-gray-600 mr-4"></i>
                        <span
                            class="text-2xl font-bold bg-gradient-to-r from-purple-600 to-indigo-600 text-transparent bg-clip-text">PubliShelf</span>
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <div class="pt-16">
        <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="rounded-xl bg-white shadow-md overflow-hidden">
                <div class="p-6 border-b">
                    <h1 class="text-2xl font-bold text-gray-900">Publish New Book</h1>
                    <p class="text-gray-500 mt-1">Fill in the details to list your book for sale</p>
                </div>

                <!-- FORM (without action/method) -->
                <form id="publishBookForm" enctype="multipart/form-data"
                    class="p-6 space-y-6 animate-fade-in">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="bookTitle" class="block text-sm font-medium text-gray-700">Book Title</label>
                            <input type="text" name="title" id="bookTitle" required
                                class="block w-full shadow-sm hover:shadow-md focus:outline-none focus:outline-purple-500 mt-1 px-2 py-1 rounded-lg border-gray-300">
                        </div>

                        <div>
                            <label class="font-medium text-gray-700 block text-sm" for="author">Author</label>
                            <input type="text" name="author" id="author" required
                                class="mt-1 px-2 py-1 block w-full rounded-lg border-gray-300 shadow-sm hover:shadow-md focus:outline-none focus:outline-purple-500">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700" for="description">Description</label>
                        <textarea rows="4" name="description" id="description" required
                            class="mt-1 py-1 px-2 block w-full rounded-lg border-gray-300 shadow-sm focus:outline-none hover:shadow-md focus:outline-purple-500"></textarea>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700" for="genre">Genre</label>
                            <select required name="genre" id="genre"
                                class="bg-white mt-1 px-2 py-1 block w-full rounded-lg border-gray-300 shadow-sm hover:shadow-md focus:outline-none focus:outline-purple-500">
                                <option disabled selected value="">Select Genre</option>
                                <option value="Fiction">Fiction</option>
                                <option value="Non-Fiction">Non-Fiction</option>
                                <option value="Mystery">Mystery</option>
                                <option value="Science Fiction">Science Fiction</option>
                                <option value="Romance">Romance</option>
                                <option value="Thriller">Thriller</option>
                            </select>
                        </div>

                        <div>
                            <label class="font-medium block text-sm text-gray-700" for="price">Price (â‚¹)</label>
                            <input type="number" name="price" id="price" step="1" min="0" required
                                class="block w-full rounded-lg border-gray-300 shadow-sm mt-1 px-2 py-1 hover:shadow-md focus:outline-none focus:outline-purple-500">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700" for="quantity">Quantity</label>
                            <input type="number" name="quantity" id="quantity" required
                                class="mt-1 px-2 py-1 block w-full rounded-lg border-gray-300 shadow-sm hover:shadow-md focus:outline-none focus:outline-purple-500">
                        </div>
                    </div>

                    <div>
                        <label class="text-gray-700 text-sm block font-medium">Book Cover Image</label>
                        <div
                            class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-lg">
                            <div class="space-y-1 text-center">
                                <i class="fas fa-cloud-upload-alt text-gray-400 text-3xl"></i>
                                <div class="flex text-sm text-gray-600">
                                    <label for="imageFile"
                                        class="relative cursor-pointer rounded-md bg-white font-medium text-purple-600 hover:text-purple-500">
                                        <span>Upload a file</span>
                                        <input name="imageFile" id="imageFile" type="file" class="sr-only"
                                            accept="image/*">
                                    </label>
                                    <p class="pl-1">or drag and drop</p>
                                </div>
                                <p class="text-gray-500 text-xs">PNG, JPG, GIF up to 10MB</p>
                            </div>
                        </div>

                        <!-- Image Preview -->
                        <div id="imagePreviewContainer" class="mt-4 hidden">
                            <h4 class="text-sm font-medium text-gray-700 mb-2">Image Preview:</h4>
                            <img id="imagePreview" class="w-48 h-64 object-cover rounded-lg shadow-md"
                                alt="Uploaded Image Preview">
                        </div>
                    </div>

                    <div class="flex justify-end space-x-4">
                        <button type="button" onclick="window.location.href='/publisher/dashboard'"
                            class="rounded-lg text-gray-700 hover:bg-gray-50 px-4 py-2 border border-gray-300">
                            Cancel
                        </button>
                        <button type="submit"
                            class="text-white hover:bg-purple-700 rounded-lg px-4 bg-purple-600 py-2">
                            Publish Book
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        const form = document.getElementById("publishBookForm");
        const imageFileInput = document.getElementById("imageFile");
        const imagePreviewContainer = document.getElementById("imagePreviewContainer");
        const imagePreview = document.getElementById("imagePreview");
        const publishBtn = form.querySelector('button[type="submit"]');

        // ðŸ§  Helper: Create dynamic error message element
        function showError(input, message) {
            clearError(input);
            const errorMsg = document.createElement("p");
            errorMsg.className = "text-red-500 text-xs mt-1 error-msg";
            errorMsg.textContent = message;
            input.classList.add("border-red-500");
            input.parentNode.appendChild(errorMsg);
        }

        // Remove previous error
        function clearError(input) {
            input.classList.remove("border-red-500");
            const existingError = input.parentNode.querySelector(".error-msg");
            if (existingError) existingError.remove();
        }

        // Validate all form fields before submission
        function validateForm() {
            let isValid = true;

            // Book Title
            const title = form.querySelector("#bookTitle");
            if (title.value.trim().length < 3) {
                showError(title, "Title must be at least 3 characters long.");
                isValid = false;
            } else clearError(title);

            // Author
            const author = form.querySelector("#author");
            if (author.value.trim().length < 3) {
                showError(author, "Author name must be at least 3 characters.");
                isValid = false;
            } else clearError(author);

            // Description
            const description = form.querySelector("#description");
            if (description.value.trim().length < 10) {
                showError(description, "Description must be at least 10 characters.");
                isValid = false;
            } else clearError(description);

            // Genre
            const genre = form.querySelector("#genre");
            if (!genre.value) {
                showError(genre, "Please select a genre.");
                isValid = false;
            } else clearError(genre);

            // Price
            const price = form.querySelector("#price");
            if (price.value <= 0) {
                showError(price, "Price must be greater than zero.");
                isValid = false;
            } else clearError(price);

            // Quantity
            const quantity = form.querySelector("#quantity");
            if (quantity.value <= 0) {
                showError(quantity, "Quantity must be at least 1.");
                isValid = false;
            } else clearError(quantity);

            // Image File
            if (!imageFileInput.files.length) {
                const uploadLabel = imageFileInput.closest("div");
                showError(uploadLabel, "Please upload a cover image.");
                isValid = false;
            } else clearError(imageFileInput.closest("div"));

            return isValid;
        }

        // Live validation (dynamic HTML behavior)
        form.querySelectorAll("input, textarea, select").forEach((input) => {
            input.addEventListener("input", () => {
                clearError(input);
            });
        });

        // Image preview
        imageFileInput.addEventListener("change", (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    imagePreview.src = e.target.result;
                    imagePreviewContainer.classList.remove("hidden");
                };
                reader.readAsDataURL(file);
                clearError(imageFileInput.closest("div"));
            } else {
                imagePreviewContainer.classList.add("hidden");
            }
        });

        // Submit handler
        form.addEventListener("submit", async (e) => {
            e.preventDefault();

            // ðŸ”¹ Validate before submit
            if (!validateForm()) {
                window.scrollTo({ top: 0, behavior: "smooth" });
                return;
            }

            const formData = new FormData(form);

            // Disable button + show loading
            publishBtn.disabled = true;
            publishBtn.textContent = "Publishing...";
            publishBtn.classList.add("opacity-70", "cursor-not-allowed");

            try {
                const response = await fetch("/publisher/publish-book", {
                    method: "POST",
                    body: formData,
                });

                const data = await response.json();

                if (data.success) {
                    window.location.href = data.redirect;
                } else {
                    alert("An unexpected error occurred.");
                }
            } catch (error) {
                console.error("Error publishing book:", error);
                alert("An error occurred while publishing the book.");
            } finally {
                publishBtn.disabled = false;
                publishBtn.textContent = "Publish Book";
                publishBtn.classList.remove("opacity-70", "cursor-not-allowed");
            }
        });
    </script>


</body>

</html>
